apiVersion: apps/v1
kind: Deployment
metadata:
  name: celery-worker
  namespace: packamal
spec:
  replicas: 1
  selector:
    matchLabels:
      app: celery-worker
  template:
    metadata:
      labels:
        app: celery-worker
    spec:
      serviceAccountName: backend-serviceaccount
      containers:
        - name: celery-worker
          # Reuses the backend image; runs the Celery worker consuming Redis jobs.
          image: packamalacr.azurecr.io/packamal-backend:latest
          imagePullPolicy: Always  # Use Always for production or specific tags
          envFrom:
            - configMapRef:
                name: packamal-config
            - secretRef:
                name: packamal-secrets
          # Override the image ENTRYPOINT (which runs migrations/collectstatic) to avoid N workers racing on startup.
          # Still waits for Postgres before starting.
          command: ["/bin/sh", "-c"]
          args:
            - |
              until nc -z database 5432; do
                echo "Waiting for database..."
                sleep 0.5
              done
              exec celery -A packamal worker -l info -n worker@%h -Q analysis --concurrency=1
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: "2"
              memory: 2Gi


